name: test123

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Deploy to GitHub Pages'
        required: true
        default: 'true'

jobs:
  test-api:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven  # Добавлено кэширование Maven зависимостей

      # Установка зависимостей для браузеров
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgbm-dev wget gnupg
          
      # Установка Playwright браузеров (улучшенная версия)
      - name: Install Playwright Browsers
        run: |
          # Устанавливаем Playwright CLI глобально через npm
          npm init -y
          npm install @playwright/test@1.40.0
          
          # Устанавливаем браузеры
          npx playwright install chromium
          npx playwright install-deps
          
          # Проверяем установку
          npx playwright --version
          ls -la ~/.cache/ms-playwright/

      - name: Prepare Allure directories
        run: |
          mkdir -p target/allure-results
          mkdir -p target/allure-report/history
          
      - name: Download previous Allure history
        uses: actions/download-artifact@v4
        with:
          name: allure-history
          path: target/allure-report/history
        continue-on-error: true
        
      - name: Run UI tests
        run: |
          # Запускаем тесты с подробным выводом
          mvn clean test -Dheadless=true -Dmaven.test.failure.ignore=true
        continue-on-error: true  # Продолжаем даже если тесты падают
        
      - name: Upload test reports
        if: always()  # Всегда загружаем отчеты, даже при падении тестов
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            target/allure-results
            target/surefire-reports
            test-results.xml
          retention-days: 30
          
      - name: Upload UI Allure results
        if: always()  
        uses: actions/upload-artifact@v4
        with:
          name: allure-ui
          path: target/allure-results
          retention-days: 30
          
      - name: Generate Allure report
        if: always()
        run: |
          mvn allure:report
          echo "Allure report generated in target/allure-report"
          
      - name: Upload Allure history
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-history
          path: target/allure-report/history
          retention-days: 90
          
      - name: Deploy to GitHub Pages
        if: ${{ github.event.inputs.deploy == 'true' && success() }}
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./target/allure-report
          force_orphan: false
          keep_files: true
          publish_branch: gh-pages
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          
      # Добавляем уведомление о статусе
      - name: Check job status
        if: always()
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "✅ Все тесты прошли успешно!"
          else
            echo "❌ Тесты упали. Проверьте логи выше для деталей."
            exit 1
          fi
